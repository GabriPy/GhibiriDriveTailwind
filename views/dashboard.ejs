<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />

    <title>Stitch Design</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
</head>

<body>
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden"
        style='font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'>
        <div class="layout-container flex h-full grow flex-col">
            <div class="gap-1 px-6 flex flex-1 py-5">
                <div class="layout-content-container flex flex-col w-80">
                    <div class="flex h-full min-h-[700px] flex-col justify-between bg-white p-4">
                        <div class="flex flex-col gap-4">
                            <h1 class="text-[#171412] text-base font-medium leading-normal">Ghibiri Drive</h1>
                            <div class="flex flex-col gap-2">
                                <a href="/dashboard">
                                    <div
                                        class="cursor-pointer flex items-center gap-3 px-3 py-2 rounded-full bg-[#f4f2f1]">
                                        <div class="text-[#171412]" data-icon="Folder" data-size="24px"
                                            data-weight="fill">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px"
                                                fill="currentColor" viewBox="0 0 256 256">
                                                <path
                                                    d="M216,72H131.31L104,44.69A15.88,15.88,0,0,0,92.69,40H40A16,16,0,0,0,24,56V200.62A15.41,15.41,0,0,0,39.39,216h177.5A15.13,15.13,0,0,0,232,200.89V88A16,16,0,0,0,216,72ZM40,56H92.69l16,16H40Z">
                                                </path>
                                            </svg>
                                        </div>
                                        <p class="text-[#171412] text-sm font-medium leading-normal">Il mio Drive</p>
                                    </div>
                                </a>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <script>
                                function openUploadModal() {
                                    document.getElementById('uploadModal').classList.remove('hidden');
                                }

                                function closeUploadModal() {
                                    document.getElementById('uploadModal').classList.add('hidden');
                                }
                            </script>


                            <button onclick="openUploadModal()"
                                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e5be98] text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]">
                                <span class="truncate">Carica un file</span>
                            </button>


                            <div id="uploadModal" class="hidden relative z-10" aria-labelledby="modal-title"
                                role="dialog" aria-modal="true">
                                <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
                                <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                                    <div class="flex min-h-full items-center justify-center p-2 sm:p-4 text-center">
                                        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all w-full max-w-md sm:max-w-xl mx-auto">
                                            <form id="uploadForm" action="/upload" method="POST"
                                                enctype="multipart/form-data" class="flex flex-col p-2 sm:p-4">
                                                <h1 class="text-[#171412] text-xl font-bold leading-tight tracking-[-0.015em] text-left pb-3 pt-2 sm:pt-5 sm:pb-3 px-2 sm:px-4">
                                                    Carica un file
                                                </h1>
                                                <div id="drop-area"
                                                    class="flex flex-col items-center gap-6 rounded-xl border-2 border-dashed border-[#e4e0dd] px-2 py-8 sm:px-6 sm:py-14 transition-colors"
                                                    style="transition: background 0.2s;">
                                                    <input id="file-upload" class="hidden" type="file" name="file"
                                                        multiple />
                                                    <div class="flex w-full max-w-xs sm:max-w-[480px] flex-col items-center gap-2">
                                                        <p class="text-[#171412] text-lg font-bold leading-tight tracking-[-0.015em] w-full text-center">
                                                            Drag and drop files here
                                                        </p>
                                                        <p class="text-[#171412] text-sm font-normal leading-normal w-full text-center">
                                                            Or
                                                        </p>
                                                    </div>
                                                    <button type="button"
                                                        class="flex min-w-[84px] max-w-full sm:max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f4f2f1] text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]"
                                                        onclick="document.getElementById('file-upload').click(); return false;">
                                                        <span class="truncate">Browse files</span>
                                                    </button>
                                                </div>
                                                <div class="flex px-2 sm:px-4 py-3 justify-end gap-2">
                                                    <button type="button" onclick="closeUploadModal()"
                                                        class="flex min-w-[84px] max-w-full sm:max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f4f2f1] text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]">
                                                        <span class="truncate">Cancel</span>
                                                    </button>
                                                    <button type="submit"
                                                        class="flex min-w-[84px] max-w-full sm:max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#e5be98] text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]">
                                                        <span class="truncate">Upload</span>
                                                    </button>
                                                </div>
                                            </form>
                                            <script>
                                                const dropArea = document.getElementById('drop-area');
                                                const fileInput = document.getElementById('file-upload');
                                                ['dragenter', 'dragover'].forEach(eventName => {
                                                    dropArea.addEventListener(eventName, (e) => {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        dropArea.classList.add('bg-[#f4f2f1]');
                                                    }, false);
                                                });
                                                ['dragleave', 'drop'].forEach(eventName => {
                                                    dropArea.addEventListener(eventName, (e) => {
                                                        e.preventDefault();
                                                        e.stopPropagation();
                                                        dropArea.classList.remove('bg-[#f4f2f1]');
                                                    }, false);
                                                });
                                                dropArea.addEventListener('drop', (e) => {
                                                    e.preventDefault();
                                                    e.stopPropagation();
                                                    if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                                                        fileInput.files = e.dataTransfer.files;
                                                    }
                                                });
                                            </script>
                                        </div>
                                    </div>
                                </div>
                            </div>



                            <!-- POPUP -->







                            <div class="flex flex-col gap-1">
                                <button onclick="openStorageModal()"
                                    class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f4f2f1] text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]">
                                    <span class="truncate">Controlla spazio drive</span>
                                </button>
                                <div class="flex items-center gap-3 px-3 py-2" style="cursor: pointer;"
                                    onclick="openStorageModal()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="layout-content-container flex flex-col max-w-[1660px] flex-1">
                    <div class="flex flex-wrap gap-2 p-4">
                        <span class="text-[#171412] text-base font-medium leading-normal">
                            Il mio Drive
                            <span style="opacity: 0.4;">
                                <% if (query && query.length> 0) { %>
                                    &nbsp;&gt;&gt; <%= query %>
                                        <% } else { %>
                                            &nbsp;<i class="fa-solid fa-hard-drive"></i>
                                            <% } %>

                            </span>
                        </span>
                    </div>
                    <div class="px-2 sm:px-4 py-3">
                        <form method="GET" action="/dashboard"
                            class="flex w-full flex-1 items-stretch rounded-xl h-full mb-4">
                            <input name="q" placeholder="Cerca in Drive"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-[#171412] focus:outline-0 focus:ring-0 border-none bg-[#f4f2f1] focus:border-none h-full placeholder:text-[#837567] px-4 border-l-0 pl-2 text-base font-normal leading-normal"
                                value="<%= typeof query !== 'undefined' ? query : '' %>" />
                        </form>
                    </div>
                    <!-- <div class="pb-3">
                        <div class="flex border-b border-[#e4e0dd] px-4 gap-8">
                            <a class="flex flex-col items-center justify-center border-b-[3px] border-b-[#171412] text-[#171412] pb-[13px] pt-4"
                                href="#">
                                <p class="text-[#171412] text-sm font-bold leading-normal tracking-[0.015em]">File</p>
                            </a>
                        </div>
                    </div> -->
                    <div class="px-4 py-3 @container">
                        <% if (files.length===0) { %>
                            <p class="subtitle has-text-centered">Nessun file caricato ancora / Nessun elemento
                                corrisponde alla tua ricerca.</p>
                            <div class="flex overflow-x-auto rounded-xl border border-[#e4e0dd] bg-white">
                                <% } else { %>
                                    <div class="flex overflow-x-auto rounded-xl border border-[#e4e0dd] bg-white">
                                        <table class="min-w-[600px] w-full">
                                            <thead>
                                                <tr class="bg-white">
                                                    <th
                                                        class="px-4 py-3 text-left text-[#171412] w-[400px] text-sm font-medium leading-normal">
                                                        Nome</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-[#171412] w-[400px] text-sm font-medium leading-normal">
                                                        Data caricamento</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-[#171412] w-[400px] text-sm font-medium leading-normal">
                                                        Dimensione file</th>
                                                    <th
                                                        class="px-4 py-3 text-left text-[#171412] w-[400px] text-sm font-medium leading-normal">
                                                        Scarica file // Elimina file</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% files.forEach(function(file) { var originalName=file.replace(/^\d+-/, ''
                                                ).replace(/_/g, ' ' ); %>
                                                    <tr class="border-t border-t-[#e4e0dd]">
                                                        <td
                                                            class="h-[72px] px-4 py-2 w-[400px] text-[#171412] text-sm font-normal leading-normal">
                                                            <%= originalName %>
                                                        </td>
                                                        <td
                                                            class="h-[72px] px-4 py-2 w-[400px] text-[#837567] text-sm font-normal leading-normal">
                                                            <%= new Date(fs.statSync(path.join('uploads',
                                                                file)).mtime).toLocaleDateString('it-IT') %>
                                                        </td>
                                                        <td
                                                            class="h-[72px] px-4 py-2 w-[400px] text-[#837567] text-sm font-normal leading-normal">
                                                            <% const sizeBytes=fs.statSync(path.join('uploads', file)).size;
                                                                let sizeFormatted='' ; if (sizeBytes < 1024 * 1024) {
                                                                sizeFormatted=(sizeBytes / 1024).toFixed(2) + ' KB' ; } else
                                                                { sizeFormatted=(sizeBytes / (1024 * 1024)).toFixed(2)
                                                                + ' MB' ; } %>
                                                                <%= sizeFormatted %>
                                                        </td>
                                                        <td
                                                            class="h-[72px] px-4 py-2 w-[400px] text-[#837567] text-sm font-normal leading-normal">
                                                        <span>
                                                            <a class="scarica-file"
                                                                href="/download/<%= encodeURIComponent(file) %>">Scarica
                                                                file</a>
                                                        </span>
                                                        //
                                                        <span>
                                                            <a class="elimina-file"
                                                                onclick="bottoneEliminaFile()">Elimina file</a>
                                                        </span>

                                                        <script>
                                                            function bottoneEliminaFile() {
                                                                if (confirm('Sei sicuro di voler eliminare questo file? ⚠️ Non lo recuperi più eh frari.')) {
                                                                    fetch('/delete', {
                                                                        method: 'POST',
                                                                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                                                        body: 'filename=' + encodeURIComponent('<%= file %>')
                                                                    }).then(() => location.reload());
                                                                } return false;
                                                            }                                                            
                                                        </script>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                            </tbody>
                                        </table>
                                    </div>
                                    <% } %>
                            </div>
                            <style>
                                @container(max-width:120px) {
                                    .table-89fc12bd-aa3f-4fc3-b691-e010f0f21c1c-column-120 {
                                        display: none;
                                    }
                                }

                                @container(max-width:240px) {
                                    .table-89fc12bd-aa3f-4fc3-b691-e010f0f21c1c-column-240 {
                                        display: none;
                                    }
                                }

                                @container(max-width:360px) {
                                    .table-89fc12bd-aa3f-4fc3-b691-e010f0f21c1c-column-360 {
                                        display: none;
                                    }
                                }

                                @container(max-width:480px) {
                                    .table-89fc12bd-aa3f-4fc3-b691-e010f0f21c1c-column-480 {
                                        display: none;
                                    }
                                }

                                .elimina-file:hover,
                                .scarica-file:hover {
                                    text-decoration: underline;
                                    cursor: pointer;
                                }

                                .elimina-file:hover {
                                    color: red !important;
                                }

                                .scarica-file:hover {
                                    color: green !important;
                                }

                                .cursor-pointer {
                                    cursor: pointer !important;
                                }
                            </style>
                    </div>


                    <div id="storageModal" class="hidden relative z-10" aria-labelledby="modal-title" role="dialog"
                        aria-modal="true">
                        <div class="fixed inset-0 bg-gray-500/75 transition-opacity" aria-hidden="true"></div>
                        <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
                            <div
                                class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                                <div
                                    class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                                    <!-- POPUP MEMORIA DRIVE -->
                                    <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                                        <div class="text-center">
                                            <p class="text-[#171412] text-base  leading-normal">Spazio del drive</p>
                                        </div>
                                        <div class="flex flex-col gap-3 p-4">
                                            <div class="flex gap-6 justify-between">
                                                <p id="storageText" class="text-sm text-gray-500">10 GB di
                                                    15 GB utilizzati</p>
                                            </div>
                                            <div class="rounded bg-[#e4e0dd]">
                                                <div class="h-2 rounded bg-[#171412]" id="storageBar"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-gray-50 px-4 py-3 flex justify-center gap-3 sm:px-6">
                                        <button type="button" onclick="closeStorageModal()"
                                            class="rounded-md bg-gray-900 px-3 py-2 text-sm font-semibold text-white shadow-xs ring-1 ring-gray-300 ring-inset hover:bg-gray-500">
                                            Chiudi
                                        </button>
                                    </div>

                                    <script>
                                        async function openStorageModal() {
                                            fetch('/api/storage')
                                                .then(res => res.json())
                                                .then data => {
                                                    const bar = document.getElementById('storageBar');
                                                    const text = document.getElementById('storageText');

                                                    const progressoBar = `${data.percentUsed.toFixed(1)}%`;

                                                    console.log(progressoBar)
                                                    bar.style.width = progressoBar;
                                                    text.innerText = `Usato: ${(data.used / 1073741824).toFixed(2)} GB / ${(data.total / 1073741824).toFixed(2)} GB`;

                                                    document.getElementById('storageModal').classList.remove('hidden');
                                                })
                                                .catch(err => {
                                                    console.error('Errore:', err);
                                                    alert('Errore nel caricare lo spazio disco');
                                                });
                                        }

                                        function closeStorageModal() {
                                            document.getElementById('storageModal').classList.add('hidden');
                                        }
                                    </script>

                                </div>

                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</body>

</html>